# Experimental!
# Uiua data plotting library

~ "git: github.com/Omnikar/uiua-math" ~ FFTConvolve Gaussian

# Apply a color to an alpha map
C â†š âœ(âŠ£Â°â‰)Ã—âˆ§â†¯â‡Œâ–³,â¬š1â†™â‚„
# Round to one significant figure
AutoRound â†š âœÃ—â…ğ„ˆâ¿10Â¯âŒŠâŠ¸â‚™10

Num  â†š Â°0type
Char â†š Â°1type
Box  â†š Â°2type

# TODO: Document this more
# The following fields can infer their values based on data:
# - `Min`
# - `Max`
# - `GridlineInterval`
# The following fields provide defaults for unspecified series-specific values:
# - `DrawDots`
# - `DotSize`
# - `DrawLines`
# - `LineWidth`
â”Œâ”€â•´PlotConfig
  ~{
    Min: Â°2Â°Â¤â–³âŸœNum â† âŠŸ.âˆ
    Max: Â°2Â°Â¤â–³âŸœNum â† âŠŸ.âˆ
    Size: Â°2Â°Â¤â–³âŸœNum â† 512_512
    BgColor: â£Â°3Â°4Â°Â¤â–³âŸœNum â† â†¯3 1
    AxisWidth: Â°[]â–³âŸœNum â† 2
    AxisColor: â£Â°3Â°4Â°Â¤â–³âŸœNum â† â†¯3 0
    GridlineWidth: Â°[]â–³âŸœNum â† 1
    GridlineColor: â£Â°3Â°4Â°Â¤â–³âŸœNum â† â†¯3 0.7
    GridlineInterval: Â°2Â°Â¤â–³âŸœNum â† âŠŸ.âˆ
    NumberSize: Â°[]â–³âŸœNum â† 15
    NumberColor: â£Â°3Â°4Â°Â¤â–³âŸœNum â† â†¯3 0.3
    XLabel: Â°[W]â–³âŸœChar â† ""
    YLabel: Â°[W]â–³âŸœChar â† ""
    AxisLabelSize: Â°[]â–³âŸœNum â† 20
    AxisLabelColor: â£Â°3Â°4Â°Â¤â–³âŸœNum â† â†¯3 0.2
    PlotLabelSize: Â°[]â–³âŸœNum â† 15
    PlotLabelColor: â£Â°3Â°4Â°Â¤â–³âŸœNum â† â†¯3 0.2
    BarWidth: Â°[]â–³âŸœNum â† 40
    BarLabels: Â°[W]â–³âŸœâˆµâ—‡CharâŸœBox â† {}
    BarLabelSize: Â°[]â–³âŸœNum â† 15
    BarLabelColor: â£Â°3Â°4Â°Â¤â–³âŸœNum â† â†¯3 0.2
    # Series-specific global defaults
    DrawDots: Â°[]â–³âŸœNum â† 1
    DotSize: Â°[]â–³âŸœNum â† 40
    DrawLines: Â°[]â–³âŸœNum â† 1
    LineWidth: Â°[]â–³âŸœNum â† 8
  }
  # Pixels per unit
  Ppu     â† Ã·-âŠƒMinâŠƒMax Size
  Bounds  â† âŒ…([âŠƒMin Max]|âŸœ[âŠƒMin Max]|âœMaxâ—ŒâœMinâ—ŒâŠ™Â°âŠŸ)
  XBounds â† âŠ¢â‰Bounds
  YBounds â† âŠ£â‰Bounds
â””â”€â•´
PC â†š PlotConfig

â”Œâ”€â•´Data
  ~{
    Values
    Color: â£Â°3Â°4Â°Â¤â–³âŸœNum â† â†¯4 âˆ
    Label: Â°[W]â–³âŸœChar â† ""
    DrawDots: Â°[]â–³âŸœNum â† âˆ
    DotSize: Â°[]â–³âŸœNum â† âˆ
    DrawLines: Â°[]â–³âŸœNum â† âˆ
    LineWidth: Â°[]â–³âŸœNum â† âˆ
  }
â””â”€â•´
# Create a `Data` instance that draws only dots
Scatter â† Data!(Â°âŠ¸DrawDots 1 Â°âŠ¸DrawLines 0 New)
# Create a `Data` instance that draws only lines
Line â† Data!(Â°âŠ¸DrawLines 1 Â°âŠ¸DrawDots 0 New)

# Stack one RGBA image atop another
Stack â† âœÂ°â‰âŠ‚ â†§âŠ¸â†¥0Ã·âŠƒ(+Ã—ğ„â¤šÂ¬|+âŠƒÃ—(Ã—ğ„Ã—Â¬)|ğ„âœâˆ©Â¬Ã—) âˆ©âœÂ°â‰Â°ğ„ˆâŠ‚

# Image ? PlotConfig
Background â† âˆ§â†¯âŠ™â¬š1â†™â‚„ PC!âŠƒSize BgColor

# Image ? PlotConfig
Axes â† (
  -âŒŠÃ·2âŸœâ‡¡âŠ¸PC~AxisWidth
  Ã—PC!âŠƒMin Ppu,
  âŠ™(Â°âŠŸPC~Size,)Â°âŠŸâŠ-
  âˆ©(Â°âŠšâ…â–½âŠ¸â‰¥0â–½)âŠ“â¤š>âŠ¸<
  âˆ©â¬š0â†™âŠ™:Â°âŠŸâ—¡â‹…â‹…PC~Size
  C PC~AxisColor:â‡Œğ„ˆâŠâ†¥)

# Image ? PlotConfig
Gridlines â† (
  âŠ¸PC!âŠƒMin Ppu
  âŠƒ(Ã—PC~GridlineIntervalâ‹…:
  | âˆ©+âŠ™:âˆ©â‡¡âˆ©Â°âŠŸPC~Size,Ã—)
  âˆ©(âŒµâœâŠ™+â—¿â¤™Ã·2)âŠ™:Â°âŠŸ
  âˆ©âŒâ‰¤Ã·2â—¡â‹…â‹…PC~GridlineWidth
  C PC~GridlineColor:â‡Œğ„ˆâŠâ†¥)

# Image ? PlotConfig
AxisNums â† â¬šâˆ˜(
  PC!âŠƒGridlineIntervalâŠƒMinâŠƒMaxâŠƒPpu SizeÂ°â—Œ
  âŠ“âŒˆâŒŠâ¤šâˆ©âŒÃ·âŠ™âŠ“â¤šâˆ˜âŠ™â‡Œ
  âˆ©Â°âŠŸâ‚†Â°âŠŸâ‰âŠŸâ‚†
  âˆ©âŠ“(
    â¤™Ã—â–½âŠ¸â‰ 0âœ-(â‡¡+1)
    âœÃ—â…ğ„ˆâ¿10â¬š0âŠ—@.â‡ŒÂ°â‹• # Round values to precision of original factor
    âš(âˆ§âŒâ†˜âŠŸâŠ¸Â¯âŠŸ.â…Ã·8âŸœlayout) PC~NumberSizeÂ°â—ŒâŠƒÂ°â‹•(Ã—ğ„ˆ-)
  )âˆ˜
  âŠ“âšâ‰âŠ™âŠ™âšâ‡Œâšâ‡Œ
  âˆ©(â™­â‚‚âˆ§â—‡(â¬š0â†¥â¬š0â†™â…âŠŸâŠ™:Â¯+âŒŠÃ·2â¤šâ§»)âŠ™âŠ™âŠ™[])
  â†¥âˆ©â‡Œâˆ©âŒâ¬š0â†™â‡ŒPC~SizeÂ°â—Œâ‰
  C PC~NumberColorÂ°â—Œ)

# Legend ? Data PlotConfig
Legend â† (
  âŠ™âŠ¸Â¤
  â‰¡PC!Data!âŠƒâ‹…PlotLabelSizeâŠƒColorâŠƒÂ°â—‡Â°Labelâ‹…PlotLabelColor
  âš(â‰¡âŠ‚âŠ“(C:â‰¡â¬š0â†™âŒŠÃ—3/2âŠ¸â§»Â¬â†¯âŸœâŠš|C:layout))â¤šâˆ˜
  PC~PlotLabelSizeâ¤™âŠ™âŠ“(âŠ¢PC~Size)âŠ“0[]â¤šâ‰¡â—‡(â§»âŠ¢)
  âŸœâŠƒ(âŠ•â–¡ğ„ˆâ–½Â°âŠâ‡ŒâŠ‚â—Œâˆ§(â¨¬â‹…âŠ“-+â‚âŠ“ğ„ˆ-â‹…âŠ“1âŠ‚: âŠ™â—¡< âŠ™+)â¤™âŠ“:âˆ˜)â‹…â‹…âˆ˜
  âŸœ(â‰¡â—‡âˆ§â‰¡â¬š0â†™â‰¡âŠŸÂ¯âŒŠÃ·2âŠ¸+â¤šâ‰¡â—‡(â§»âŠ¢)âš/â—‡â‰¡(âŠ‚âŠ‚)Â¤â‰â†¯4â†¯âŸœâŠš)
  âŸœ(/(âŠ‚âŠ‚)â‰â†¯4ğ„ˆâ†¯0ğ„ˆâŠŸâŠ¡2â–³,)
  âˆ§âŒâ†˜âŠŸâŠ¸Â¯âŒŠÃ·2)

# Convolution kernels
# Rounding dot size up to an odd number gives
# the post-convolution array the correct shape

# Kernel ? Size
CircleKernel â†š â¿4â†§1Ã—2âˆšâ‚â‚†Gaussianâ¤™Ã·40âœ(Ã·2+1)â…

# Kernel ? Size
XKernel â†š (
  0.3:Â¤â†¥âŠ¸â‡ŒâŠ=.âŠ¸â‡¡âœ(Ã·2+1)â…Ã—0.3
  /â†¥â‰¡â†»â™­â‚‚âŠâŠŸ.-Ã·2-1âŸœâ‡¡âœ(Ã·2+1)âŒŠÃ—)

# Kernel ? Size
BoxKernel â†š Â¬â†¯âŸœâŠšâœ(Ã·2+1)â…Ã—0.3

# Non-rounded non-bound-checked pixel coordinates of points
# Coords ? Points PlotConfig
PointsToPx â†š â‰¡â‡ŒÃ—âŠ™-âˆ©Â¤PC!âŠƒPpu Min:

# Image ? Data PlotConfig
Dots â† (
  â¤šâ¤™(â…PointsToPx Data~Values)
  â‡Œâ¬š0â†™:Â°âŠš â–½âŠ¸âˆŠâ™­â‚‚â¤šâ‡¡â‡ŒPC~Size
  CircleKernel Data~DotSize,
  â†˜Â¯âŸœâ†˜âŒŠÃ·2â–³âŸœFFTConvolve
  â†§1C Data~Color:)

# Image ? Data PlotConfig
Lines â† (
  â¤šâ¤™(â§ˆâˆ˜2â‰¡/â„‚PointsToPx Data~Values)
  Â¤/â„‚Â°â‰â‡¡â‡ŒPC~Size
  â‡Œ/â†§â‰¡/(âŒµ-Ã—â†¥0â†§1Ã·âˆ©(/+Ã—âˆ©âŠŸâˆ©Â°â„‚)â¤™â¤™â— :âˆ©âŒ-)
  Â¬â†¥0â†§1-Ã·10Data~LineWidth,Ã—0.7
  C Data~Color:)

# Plot a single series
# Image ? Data PlotConfig
SingleSeries â† /Stack[
  â‹…â—Œâ¥â— DotsâŠ¸Data~DrawDots
  â¥â— LinesâŠ¸Data~DrawLines]

# Bars ? Data PlotConfig
SingleBars â† (
  â¤šPC~YBoundsğ„ˆâŠ™âŠ¸Data~Values
  âŸœâŠƒ(â†¥âŠ™â†§Â°âŠŸ)âŠ¢
  â†¥âŠƒ(â†¥0-â†¥0âŠ¢|âŒµâ†§0-â†§0âŠ£|Â¯â†§0-â†§0â—Œ)
  âˆ©Ã—,âŠ™(âŠ£PC~Ppu,)
  â¬š0â‰¡âŒâ†˜â…:â¬š0â‰¡â†¯âŠ™1â…â‰¡âŠŸâŠ™PC~BarWidthâŠ™,
  PC!âŠƒBarWidth Size,
  â…+Ã·2-âŠ™(âŠ¸âŠ¡1Ã—Ã·âŸœâ‡¡â§»,âŠ¢)
  â‡Œâ¬š0â†™â‡ŒPC~Size:/â†¥â¬š0â‰¡â‰¡âŒâ†˜
  C Data~Color:)

Bars â† (
  âœâ¬š0â‰¡Data~Valuesâˆ˜
  â‰¡SingleBarsâŠ™âŠ¸Â¤
  PC~BarWidth:
  â…Ã—â‡Œ-Ã·2-1âŸœâ‡¡â§»,
  /Stackâ‰¡â‰¡â†»)

# Generate a `Data` instance that plots a given function
# Data ? XBounds
Func! â† (
  â¤š/-âŠ™PC!(Size New)
  â‰¡âŠŸâŸœâˆµ^0ğ„ˆâŠ‚âŠ£â¤™âœÃ—/âœ-(â‡¡â…)Ã·5Ã·âŠ™âŠ¢
  Data!(Â°âŠ¸DrawDots0New))

# Colors from Desmos graphing calculator
# https://www.desmos.com/api/v1.7/docs/index.html#document-colors
DefaultColors â† â‰¡âŠ‚Ã·255[
  199_68_64
  45_112_179
  56_140_70
  96_66_166
  250_126_25
  0_0_0
]1

# Infer values for a config field using
# a function that operates on input data
# ? FieldGetter InferenceFunction
Inferâ€¼ â†š âŸœ(âœ(âˆ©â™­^0|âœâˆ©â–½â—Œâ¤šâˆ˜âŠ¸=âˆ):^1)
# Inherit defaults from a PlotConfig to
# the DataConfigs of some data
# ? DataConfigGetter PlotConfigGetter
Inheritâ€¼ â†š âœ:Inferâ€¼â‰¡^0(â‰¡âŠ™âˆ˜^1)

ColorAutoInfer â† (
  â‰¡âœData~Colorâ¬šâˆâ†™â‚„
  âœ:Inferâ€¼â‰¡Data~Colorâ‹…(âŠâ—¿â§»,â‡¡â§»,DefaultColors)
)

PreChart â† (
  âŠ™âŸœBackground
  âŸœ(Â±âŠ¸â§»â–½>0âŠ¸â‰¡(â§»Data~Label)
    â¨¬â‹…âŸœ(Â°â–³[0âŠ™4]âŠ¢PC~Size)(â¤š(âœâŠ™(âŠ£PC~Size)-â§»)âŠ¸Legend))
  âŠ™(>0âŠ¸[âˆ©â§»PC!âŠƒYLabel XLabel]âŸœPC~Size
    âœâŠ™PC~Size-Ã—+âŸœ+âŒŠâŠ¸Ã·4 PC~AxisLabelSize,))

PostChart â† (
  PC!âŠƒAxisLabelColorâŠƒAxisLabelSizeâŠƒXLabel YLabel:
  âŠ™âˆ©âŒ(âˆ§âŒâ†˜âŠŸâŠ¸Â¯âŒŠÃ·4âŸœlayout)
  âŠ¡1â–³:âŠ™(âŸœâ§»,)âˆ©âŒ(â¤¸1â‰âŠÃ—)â¬š1â†™â‚„
  âŠ™ğ„ˆâŠ‚:â¤¸1âŠ™â‡Œâˆ©(â†»âŒŠÃ·2-âŠƒâŠ™â§»â¬š0â†™)
  Stackğ„ˆâŠ‚â†™Ã—1_Â¯1â‡Œ:â‰¡âŠ‚â¬š0â†™â§»,)

# TODO: Document this more
# Create a line/scatter plot with a list of `Data`
# Each `Data~Values` should be a list of 2D coordinates,
# stored as a single rank 2 array.
# Use `â¬š fill` to provide a custom `PlotConfig`.
# Image ? Data
Plot â† (
  ColorAutoInfer âŠ™â£Â°â—ŒPC â™­â‚‚

  PC!Inferâ€¼GridlineInterval(AutoRoundÃ·5-âŠƒ/â†§/â†¥/â—‡âŠ‚âšData~Values)
  PC!Inferâ€¼Min(-Ã·5GridlineInterval,/â†§/â—‡âŠ‚âšData~Values)
  PC!Inferâ€¼Max(+Ã·5GridlineInterval,/â†¥/â—‡âŠ‚âšData~Values)
  Inheritâ€¼Data~DrawDots PC~DrawDots
  Inheritâ€¼Data~DotSize PC~DotSize
  Inheritâ€¼Data~DrawLines PC~DrawLines
  Inheritâ€¼Data~LineWidth PC~LineWidth

  PreChart
  /StackâŠ¸[
    /Stackâ‡Œâ‰¡SingleSeriesâŠ™Â¤
    âŠ™âŸœ(AxisNums|Axes|Gridlines)]
  PostChart)

# TODO: Document this more
# Create a bar chart with a list of `Data`
# Each `Data~Values` should be a list of bar heights.
# Use `â¬š fill` to provide a custom `PlotConfig`.
# Image ? Data
BarChart â† (
  âŠ™âœPC~XBoundsâ‹…1_1 â™­â‚‚ âŠ™â£Â°â—ŒPC
  PC!Inferâ€¼YBounds(âŠŸâŠ“âŒâ†§â†¥0âˆ©(+âŠ¸Ã·20)âŠƒ/â†§/â†¥â™­â¬š0â‰¡Data~Values)
  PC!Inferâ€¼(âŠ£GridlineInterval|AutoRoundÃ·5/-â‹…âŠ¸YBounds)
  ColorAutoInfer
  âŠ™âœ(âŠ¢PC~GridlineInterval)â‹…âˆ

  PreChart

  â— (â¬š""â†™âŠ™âŠ¸PC~BarLabels/â†¥â‰¡(â§»Data~Values)
    âšâŒâ†˜â…Ã·8âŸœâšlayoutPC~BarLabelSize,
    Ã—Ã·âŸœâ‡¡â§»,âŠ¢PC~Size,
    â…+Ã·2-âŠ™âŠ¸âŠ¡â‚â‰¡â—‡(â§»âŠ¢),
    â‰¡â¬š0â†™âŠ¢PC~Size,/â†¥â¬š0â‰¡â—‡â‰¡âŒâ†˜
    C PC~BarLabelColor:)
  âŠ™(âœâŠ™(âŠ£PC~Size)-â§»,)

  âŠ‚âŠ™:/Stack âŠ¸[âŠ™::BarsâŠ™âŸœ(AxisNums|Axes|Gridlines)]

  PostChart)

# TODO: Document this more
# Create a histogram with a single set of `Data`
# `Data~Values` should be a list of numbers.
# Use `â¬š fill` to provide a custom `PlotConfig`.
# Histogram bucket intervals can be specified
# through the x component of `GridlineInterval`
# in the `PlotConfig`.
# Image ? Data
Histogram â† (
  âŠ™â£Â°â—ŒPC
  PC!Inferâ€¼(âŠ¢GridlineInterval|AutoRoundÃ·10-âŠƒ/â†§/â†¥Data~Values)
  PC!Inferâ€¼XBounds(âœÃ·â…âŠ¢GridlineInterval,âŠŸâŠƒ/â†§/â†¥Data~Values)
  âœâ™­â‚‚ColorAutoInfer
  âœData~Values(
    âŠ¢PC!âŠƒGridlineInterval XBounds,
    Â°âŠ‚âœÃ·(âœ-(â‡¡â…+1)Â°âŠŸ)
    â¬š0â†™â§»:Â°âŠšâŠ—1âŠ¸âŠâ‰¥â–½âŠ¸â‰¥âŠ™:)

  âœÂ¤PreChart

  âŠ™Â°âŠ¸PC~BarWidth:âŒˆâŠ¢Ã—PC!âŠƒPpu GridlineInterval,
  PC!Inferâ€¼YBounds(âŠŸ0â…Ã—1.04/â†¥Data~Values)
  PC!Inferâ€¼(âŠ£GridlineInterval|AutoRoundÃ·5/-â‹…âŠ¸YBounds)
  /StackâŠ¸[âŠ™::SingleBarsâŠ™âŸœ(AxisNums|Axes|Gridlines)]

  PostChart)
